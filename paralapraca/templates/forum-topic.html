{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load compress %}

{% block js %}
    {{ block.super }}
    {% compress css %}
        <link rel="stylesheet" type="text/css" href="{% static 'angular-ui-select/dist/select.css' %}">
    {% endcompress %}

    <script type="text/javascript" src="{% static 'tinymce-dist/tinymce.js' %}"></script>
    {% compress js %}
    <script type="text/javascript" src="{% static 'js/timtec-discussion-app.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/discussion-app.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/discussion-controllers.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/discussion-services.js' %}"></script>
    <script type="text/javascript" src="{% static 'angular-ui-tinymce/src/tinymce.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/ui.tinymce.config.js' %}"></script>
    <script type="text/javascript" src="{% static 'ng-file-upload/ng-file-upload.js' %}"></script>
    <script type="text/javascript" src="{% static 'angular-sanitize/angular-sanitize.js' %}"></script>
    <script type="text/javascript" src="{% static 'angular-ui-select/dist/select.js' %}"></script>
    {% endcompress %}

{% endblock %}

{% block body_attrs %}
  ng-app="timtec.discussion"
{% endblock %}

{% block content %}
<ng-view></ng-view>

{% verbatim %}
<script type="text/ng-template" id="topic-detail.html">
    <section class="forums forums-page forums-widget thread widget container-fluid">
        <div class="widget-topbar">
            <div class="line">
                <div class="pull-left">
                    <h2 class="title" ng-cloak>Fóruns > {{ topic.forum_info.title }}</h2>
                </div>
                <div class="pull-right">
                    <a class="btn btn-sm btn-success new-topic"
                   href="/discussion/topic/new/#!/topic/new/">criar novo tópico</a>
                    <a ng-href="/discussion/#!/forum/{{ topic.forum }}" class="btn btn-link goback"><span>voltar para os tópicos</span></a>
                </div>
            </div>
        </div>

        <div class="line one-column">
            <div class="column">
                <div class="forum-thread" ng-cloak>
                    <form class="new-thread" name="topic_form" novalidate ng-show="updating" ng-submit="topic_form.$valid && update_topic()">
                        <div class="form-group">
                            <div class="row">
                              <div class="col-sm-6">
                                  <h3 class="title" ng-cloak>Editar Tópico</h3>
                              </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <label for="thread-forum">Em qual fórum ele deve estar? <span class="help-text">escolha apenas um</span></label>
                                    <select ng-model="topic.forum" name="forum" class="form-control" id="thread-forum"
                                            ng-options="forum.id as forum.title for forum in forums" required>
                                        <option>Escolha o fórum</option>
                                    </select>
                                </div>
                                <!-- <div class="col-sm-6">
                                    <div class="help-text">fórum escolhido</div>
                                    <div class="selected-forum">Avante e Entremeios</div>
                                </div> -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="thread-name">Título do tópico<span class="help-text">(campo obrigatório)</span></label>
                            <input ng-model="topic.title" name="title" type="text" class="form-control" id="thread-name" placeholder="Escreva o título aqui" required>
                        </div>
                        <div class="form-group">
                            <label for="thread-text">Texto do tópico</label>
                            <textarea ui-tinymce
                                      ng-model="topic.content"
                                      placeholder="Escreva aqui sua resposta" required></textarea>
                        </div>

                        <div class="form-group">
                            <button id="select-file-topic"
                                   class="btn btn-xs btn-primary attach"
                                   ngf-select="uploadTopicFiles($file, topic)"
                                   ngf-multiple="false">anexar arquivo</button>
                        </div>
                        <div class="form-group">
                            <div class="post-attachments"
                               ng-show="topic.files">
                                <div class="attachments">
                                    <span translate
                                          translate-n="topic.files.length"
                                          translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                    <ul>
                                        <li ng-repeat="file in topic.files">
                                            <a ng-href="{{file.file}}">{{file.name}}</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-sm-6">
                                    <label for="thread-forum">Qual a categoria do seu tópico? <span class="help-text">escolha apenas uma (campo obrigatório)</span></label>
                                    <ui-select multiple limit="1" ng-model="topic.categories" theme="bootstrap" title="Escolha as categorias..." required>
                                      <ui-select-match placeholder="Selecione uma categoria...">{{$item.name}}</ui-select-match>
                                      <ui-select-choices repeat="category in categories | filter: {name: $select.search}" group-by="">
                                        <div ng-if="!tag.isTag" ng-bind-html="category.name + tag.isTag | highlight: $select.search"></div>
                                      </ui-select-choices>
                                    </ui-select>
                                </div>
                                <!-- <div class="col-sm-6">
                                    <div class="help-text">categoria escolhida</div>
                                    <div class="selected-category">
                                        <span class="category discussion" ng-repeat="category in new_topic.categories">{{category}}</span>
                                    </div>
                                </div> -->
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-sm-6">
                                    <label for="thread-tags">Para terminar, escolha algumas tags</label>

                                    <ui-select multiple tagging="tagTransform" ng-model="topic.tags" theme="bootstrap" title="Escolha algumas tags...">
                                      <ui-select-match placeholder="Selecione uma tag...">#{{$item.name}}</ui-select-match>
                                      <ui-select-choices repeat="tag in tags | filter: {name: $select.search}" group-by="">
                                        <div ng-if="tag.isTag" ng-bind-html="(tag.name | highlight: $select.search) +' (nova tag)'"></div>
                                        <div ng-if="!tag.isTag" ng-bind-html="tag.name + tag.isTag | highlight: $select.search"></div>
                                      </ui-select-choices>
                                    </ui-select>
                                </div>
                                <!-- <div class="col-sm-6">
                                    <div class="help-text">tags escolhidas</div>
                                    <div class="selected-tags tags">
                                        <a href="#" class="tag" ng-repeat="tag in new_topic.tags">#{{tag}}</a>
                                    </div>
                                </div> -->
                            </div>
                        </div>

                        <button type="submit"
                                class="btn btn-success new-topic">postar nova resposta</button>
                    </form>

                    <div ng-show="!updating">
                      <div class="user-icon">
                          <img ng-src="{{ topic.author.picture }}" alt="{{ topic.author.name }}">
                      </div>
                      <div class="info">
                          <h4 class="thread-header"><span class="thread-title">{{ topic.title }}</span> por <a class="user-name" ng-href="/profile/{{ topic.author.username }}">{{ topic.author.name }}</a></h4>
                      </div>
                      <div class="tags">
                          <a class="tag" ng-repeat="category in topic.categories">#{{ category.name }}</a>
                      </div>
                      <div class="tags">
                          <a class="tag" ng-repeat="tag in topic.tags">#{{ tag.name }}</a>
                      </div>

                      <div class="thread-post">
                          <div ng-bind-html="get_as_safe_html(topic.content)"></div>

                          <!-- TODO: transformar em diretiva -->
                          <button class="btn btn-xs attached"
                                  ng-show="(topic.files.length > 1) && !topic.show_files"
                                  ng-click="topic.show_files=true">
                              <u>{{topic.files.length}} arquivos anexos</u> + ...
                          </button>
                          <div class="post-attachments"
                               ng-show="(topic.files.length === 1) || topic.show_files">
                              <div class="attachments">
                                  <span translate
                                        translate-n="topic.files.length"
                                        translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                  <ul>
                                      <li ng-repeat="file in topic.files">
                                          <a ng-href="{{file.file}}">{{file.name}}</a>
                                      </li>
                                  </ul>
                              </div>
                          </div>
                          <!-- END TODO: transformar em diretiva -->
                      </div>
                    </div>

                    <div class="actions">
                        <div class="pull-left">
                            <a ng-click="topic_like(topic)" ng-class="{ 'active': topic.user_like }" class="action liked">gostei</a>
                            <!--<a class="action used">usar</a>-->
                            <a ng-click="topic.show_comment_input=true" class="action replies">comentar</a>
                            <a class="action edit" ng-click="updating=true" ng-show="topic.author.id == user.id && !updating">editar</a>
                            <span class="last-update">última edição {{ topic.updated_at | date : "d 'de' MMMM 'de' yyyy 'às' HH'h'mm" }}</span>
                        </div>
                        <div class="pull-right">
                          <span class="action liked"
                                ng-class="{ 'active': topic.count_likes }"
                                translate
                                translate-n="topic.count_likes"
                                translate-plural="{{$count}} gostaram">1 gostou</span>
                            <span class="action replies"
                                  ng-class="{ 'active': topic.count_replies }"
                                  translate
                                  translate-n="topic.count_replies"
                                  translate-plural="{{$count}} comentários">1 comentário</span>
                            <!--<span class="action used">7 usaram</span>-->
                        </div>
                    </div>

                    <form class="comments-form" ng-show="topic.show_comment_input">
                        <textarea ui-tinymce
                                  ng-model="topic.new_comment"
                                  placeholder="Escreva aqui o seu comentário"></textarea>
                        <button id="select-file-topic"
                               class="btn btn-xs btn-primary attach pull-left"
                               ngf-select="uploadCommentFiles($file, topic)"
                               ngf-multiple="false">anexar arquivo</button>
                        <button class="btn btn-xs btn-success reply pull-right" ng-click="save_comment(topic, null)">comentar</button>
                        <button class="btn btn-xs btn-danger delete pull-right" ng-click="topic.show_comment_input=false">descartar</button>

                        <div class="post-attachments"
                             ng-show="topic.new_comment_files">
                            <div class="attachments">
                                <span translate
                                      translate-n="topic.new_comment_files.length"
                                      translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                <ul>
                                    <li ng-repeat="file in topic.new_comment_files">
                                        <a ng-href="{{file.file}}">{{file.name}}</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </form>

                    <div class="comments">
                        <h3 class="comments-title">Comentários</h3>
                        <div class="thread" ng-repeat="comment in topic.comments">
                            <div class="user-icon">
                                <img ng-src="{{ comment.author.picture }}" alt="{{ comment.author.name }}">
                            </div>
                            <div class="info">
                                <span class="user-name">
                                  <a ng-href="/profile/{{ comment.author.username }}">{{ comment.author.name }}</a>
                                </span>
                                <div class="comment-post" ng-if="!comment.updating">
                                    <div ng-bind-html="get_as_safe_html(comment.text)"></div>

                                    <!-- TODO: transformar em diretiva -->
                                    <button class="btn btn-xs attached"
                                            ng-show="(comment.files.length > 1) && !comment.show_files"
                                            ng-click="comment.show_files=true">
                                        <u>{{comment.files.length}} arquivos anexos</u> + ...
                                    </button>
                                    <div class="post-attachments"
                                         ng-show="(comment.files.length === 1) || comment.show_files">
                                        <div class="attachments">
                                            <span translate
                                                  translate-n="comment.files.length"
                                                  translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                            <ul>
                                                <li ng-repeat="file in comment.files">
                                                    <a ng-href="{{file.file}}">{{file.name}}</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <!-- TODO END: transformar em diretiva -->
                                </div>
                                <form class="comments-form" ng-if="comment.updating" ng-init="comment.new_text = comment.text">
                                    <textarea ui-tinymce
                                              ng-model="comment.new_text"
                                              placeholder="Escreva aqui o seu comentário"></textarea>
                                    <button id="select-file-topic"
                                           class="btn btn-xs btn-primary attach pull-left"
                                           ngf-select="uploadCommentFiles($file, topic)"
                                           ngf-multiple="false">anexar arquivo</button>
                                    <button class="btn btn-xs btn-success reply pull-right" type="submit" ng-click="update_comment(comment)">comentar</button>
                                    <button class="btn btn-xs btn-danger delete pull-right" ng-click="comment.updating=false">descartar</button>

                                    <div class="post-attachments" ng-init="topic.new_comment_files = comment.files"
                                         ng-show="topic.new_comment_files">
                                        <div class="attachments">
                                            <span translate
                                                  translate-n="topic.new_comment_files.length"
                                                  translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                            <ul>
                                                <li ng-repeat="file in topic.new_comment_files">
                                                    <a ng-href="{{file.file}}">{{file.name}}</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="actions">
                                <div class="pull-left">
                                    <a ng-click="comment_like(comment)"
                                       ng-class="{ 'active': comment.user_like }"
                                       class="action liked">gostei</a>
                                    <a ng-click="comment.show_comment_input=true" class="action replies">responder</a>
                                    <a class="action edit" ng-click="comment.updating=true" ng-show="comment.author.id == user.id && !comment.updating">editar</a>
                                    <span class="last-edit">{{ comment.updated_at | date : "d 'de' MMMM 'de' yyyy 'às' HH'h'mm" }}</span>
                                </div>
                                <div class="pull-right">
                                    <span class="action liked"
                                          ng-class="{ 'active': comment.count_likes }"
                                          translate
                                          translate-n="comment.count_likes"
                                          translate-plural="{{$count}} gostaram">1 gostou</span>
                                    <!--<span class="action replies">30 respostas</span>-->
                                </div>
                            </div>
                            <div class="info">
                                <form class="comments-form" ng-show="comment.show_comment_input">
                                    <textarea ui-tinymce
                                              ng-model="comment.new_comment"
                                              placeholder="Escreva aqui o seu comentário"></textarea>
                                    <!-- <button class="btn btn-xs btn-primary attach pull-left">anexar arquivo</button> -->
                                    <button id="select-file-comment"
                                           class="btn btn-xs btn-primary attach pull-left"
                                           ngf-select="uploadCommentFiles($file, comment)"
                                           ngf-multiple="false">anexar arquivo</button>
                                    <button class="btn btn-xs btn-success reply pull-right" ng-click="save_comment(topic, comment);comment.show_comment_input=false;">responder</button>
                                    <button class="btn btn-xs btn-danger delete pull-right" ng-click="comment.show_comment_input=false">descartar</button>
                                    <div class="post-attachments"
                                         ng-show="comment.new_comment_files">
                                        <div class="attachments">
                                            <span translate
                                                  translate-n="comment.new_comment_files.length"
                                                  translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                            <ul>
                                                <li ng-repeat="file in comment.new_comment_files">
                                                    <a ng-href="{{file.file}}">{{file.name}}</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="thread" ng-repeat="reply in comment.comment_replies">
                                <div class="user-icon">
                                    <img ng-src="{{ reply.author.picture }}" alt="{{ reply.author.name }}">
                                </div>
                                <div class="info">
                                    <div ng-show="!reply.updating">
                                        <span class="user-name">
                                          <a ng-href="/profile/{{ reply.author.username }}">{{ reply.author.name }}</a>
                                        </span>
                                        <div class="comment-post">
                                            <div ng-bind-html="get_as_safe_html(reply.text)"></div>
                                            <!-- TODO: transformar em diretiva -->
                                            <button class="btn btn-xs attached"
                                                    ng-show="(reply.files.length > 1) && !reply.show_files"
                                                    ng-click="reply.show_files=true">
                                                <u>{{reply.files.length}} arquivos anexos</u> + ...
                                            </button>
                                            <div class="post-attachments"
                                                 ng-show="(reply.files.length === 1) ||reply.show_files">
                                                <div class="attachments">
                                                    <span translate
                                                          translate-n="reply.files.length"
                                                          translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                                    <ul>
                                                        <li ng-repeat="file in reply.files">
                                                            <a ng-href="{{file.file}}">{{file.name}}</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <!-- TODO END: transformar em diretiva -->
                                        </div>
                                    </div>
                                    <form class="comments-form" ng-if="reply.updating" ng-init="reply.new_text = reply.text">
                                        <textarea ui-tinymce
                                                  ng-model="reply.new_text"
                                                  placeholder="Escreva aqui o seu comentário"></textarea>
                                        <button id="select-file-topic"
                                               class="btn btn-xs btn-primary attach pull-left"
                                               ngf-select="uploadCommentFiles($file, topic)"
                                               ngf-multiple="false">anexar arquivo</button>
                                        <button class="btn btn-xs btn-success reply pull-right" type="submit" ng-click="update_comment(reply)">comentar</button>
                                        <button class="btn btn-xs btn-danger delete pull-right" ng-click="reply.updating=false">descartar</button>

                                        <div class="post-attachments" ng-init="topic.new_comment_files = reply.files"
                                             ng-show="topic.new_comment_files">
                                            <div class="attachments">
                                                <span translate
                                                      translate-n="topic.new_comment_files.length"
                                                      translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                                <ul>
                                                    <li ng-repeat="file in topic.new_comment_files">
                                                        <a ng-href="{{file.file}}">{{file.name}}</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </form>


                                    <form class="comments-form" ng-show="reply.show_comment_input">
                                        <textarea ui-tinymce
                                                  ng-model="comment.new_comment"
                                                  placeholder="Escreva aqui o seu comentário"></textarea>
                                        <button id="select-file-reply"
                                                class="btn btn-xs btn-primary attach pull-left"
                                                ngf-select="uploadCommentFiles($file, comment)"
                                                ngf-multiple="false">anexar arquivo</button>
                                        <button class="btn btn-xs btn-success reply pull-right" ng-click="save_comment(topic, comment);reply.show_comment_input=false;">responder</button>
                                        <button class="btn btn-xs btn-danger delete pull-right" ng-click="reply.show_comment_input=false">descartar</button>
                                        <div class="post-attachments"
                                             ng-show="comment.new_comment_files">
                                            <div class="attachments">
                                                <span translate
                                                      translate-n="comment.new_comment_files.length"
                                                      translate-plural="{{$count}} arquivos anexos:">1 arquivo anexo:</span>
                                                <ul>
                                                    <li ng-repeat="file in comment.new_comment_files">
                                                        <a ng-href="{{file.file}}">{{file.name}}</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="actions">
                                    <div class="pull-left">
                                        <a ng-click="comment_like(reply)"
                                           ng-class="{ 'active': reply.user_like }"
                                           class="action liked">gostei</a>
                                        <a ng-click="reply.show_comment_input=true" class="action replies">responder</a>
                                        <a class="action edit" ng-click="reply.updating=true" ng-show="reply.author.id == user.id && !reply.updating">editar</a>
                                        <span class="last-edit">{{ reply.updated_at | date : "d 'de' MMMM 'de' yyyy 'às' HH'h'mm" }}</span>
                                    </div>
                                    <div class="pull-right">
                                        <span class="action liked"
                                              ng-class="{ 'active': reply.count_likes }"
                                              translate
                                              translate-n="reply.count_likes"
                                              translate-plural="{{$count}} gostaram">1 gostou</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</script>
{% endverbatim %}
{% endblock %}
