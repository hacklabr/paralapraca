{% extends 'base.html' %}

{% block wrapper_classes %}{{ block.super }}
chat rocketchat
{% endblock %}

{% block body_attrs %}
  ng-app="header"
{% endblock %}

{% block content %}
<iframe id="chat-frame" src="{{ rocketchat.address }}" name="chat"></iframe>
{% endblock %}


{% block footer %}
<script type="text/javascript">(function triggerrc($){
    var tries = 10;

    var itid = setInterval(function(){
        if(tries-- < 1) {
            clearInterval(itid);
            return;
        }

        $('#chat-frame').each(function(){
            var iframeWindow = this.contentWindow;
            iframeWindow.postMessage({
                externalCommand: 'call-custom-oauth-login',
                service: '{{ rocketchat.service }}'
            }, '*');
        });

    }, 300);

    window.addEventListener("message", function(data) {
        if(data.eventName !== 'unread-changed') {
            clearInterval(itid);
        }
    }, false);

})(jQuery);</script>
{% endblock %}