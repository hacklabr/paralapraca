{% extends 'base.html' %}
{% load join_path %}

{% block wrapper_classes %}{{ block.super }}
chat rocketchat
{% endblock %}

{% block body_attrs %}
  ng-app="header"
{% endblock %}

{% block content %}
<iframe id="chat-frame" src="{% join_path rocketchat.address 'channel/general' %}" name="chat"></iframe>
{% endblock %}


{% block footer %}
<script type="text/javascript">(function triggerrc($){
    var tries = 100;

    var itid = setInterval(function(){
        if(tries-- < 1) {
            clearInterval(itid);
            console.error('Falha na tentativa de login')
            return;
        }

        $('#chat-frame').each(function(){
            var iframeWindow = this.contentWindow;
            iframeWindow.postMessage({
                externalCommand: 'call-custom-oauth-login',
                service: '{{ rocketchat.service }}'
            }, '*');
        });

    }, 1000);

    window.addEventListener("message", function(data) {
        if(data.eventName === "custom-oauth-callback") {
            clearInterval(itid);
        }
    }, false);

})(jQuery);</script>
{% endblock %}
